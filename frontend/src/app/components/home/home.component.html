<div class="home-container">
  @if (errorMessage()) {
    <div class="error-popup">
      <div class="error-content">
        <p>{{ errorMessage() }}</p>
        <button (click)="errorMessage.set(null)">Close</button>
      </div>
    </div>
  }

  <nav class="navbar">
    <div class="nav-content">
      <h1>For The Birds</h1>
      <div class="nav-actions">
        @if (currentUser) {
          <div class="user-info-container">
            <span class="user-info">
              Welcome, {{ currentUser.username }}!
            </span>
            <a class="attributions-link" (click)="showAttributions()">Attributions</a>
          </div>
        }
        <div style="position: relative;">
          <button class="btn btn-menu" (click)="toggleMenu()">☰</button>
          @if (showMenu) {
            <div class="dropdown-menu" (click)="$event.stopPropagation()">
              @if (currentUser?.userType === 'admin') {
                <button class="menu-item" (click)="openPreferences()">Preferences</button>
                <button class="menu-item" (click)="openUsersDialog()">Manage Users</button>
              }
              <button class="menu-item" (click)="logout()">Logout</button>
            </div>
          }
        </div>
      </div>
    </div>
  </nav>

  <div class="content">
    <div class="logged-in-users">
      <h3>Logged In Users</h3>
      <div class="users-list">
        @if (loggedInUsers().length === 0) {
          <p class="no-users">No users logged in</p>
        }
        @for (user of loggedInUsers(); track user.id) {
          <div class="user-item">{{ user.username }}</div>
        }
      </div>
    </div>

    <div class="cards-grid">
      @for (table of tables(); track table.id) {
        <div class="card">
          <div class="card-image" (click)="onCardImageClick($event, table.id)">
            <!-- Start/Continue Button -->
            @if (hasPlayers(table) && isUserAtTable(table)) {
              <button class="start-button" (click)="startGame(table.id); $event.stopPropagation()" [title]="getButtonText(table) + ' game'">
                {{ getButtonText(table) }}
              </button>
            }
            
            <!-- North Position -->
            <div class="position position-north" 
                 [class.empty]="!hasPlayerAtPosition(table, 'north')"
                 [class.occupied]="hasPlayerAtPosition(table, 'north')"
                 [title]="getPlayerName(table, 'north')"
                 (click)="onPositionClick(table.id, 'north', !!table.positions.north); $event.stopPropagation()">
              @if (hasPlayerAtPosition(table, 'north')) {
                <img [src]="isComputerPlayer(table, 'north') ? '/images/computer.png' : '/api/images/user.png'" alt="North player" />
                <span class="player-name player-name-left">{{ getPlayerName(table, 'north') }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- South Position -->
            <div class="position position-south" 
                 [class.empty]="!hasPlayerAtPosition(table, 'south')"
                 [class.occupied]="hasPlayerAtPosition(table, 'south')"
                 [title]="getPlayerName(table, 'south')"
                 (click)="onPositionClick(table.id, 'south', !!table.positions.south); $event.stopPropagation()">
              @if (hasPlayerAtPosition(table, 'south')) {
                <img [src]="isComputerPlayer(table, 'south') ? '/images/computer.png' : '/api/images/user.png'" alt="South player" />
                <span class="player-name player-name-right">{{ getPlayerName(table, 'south') }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- East Position -->
            <div class="position position-east" 
                 [class.empty]="!hasPlayerAtPosition(table, 'east')"
                 [class.occupied]="hasPlayerAtPosition(table, 'east')"
                 [title]="getPlayerName(table, 'east')"
                 (click)="onPositionClick(table.id, 'east', !!table.positions.east); $event.stopPropagation()">
              @if (hasPlayerAtPosition(table, 'east')) {
                <img [src]="isComputerPlayer(table, 'east') ? '/images/computer.png' : '/api/images/user.png'" alt="East player" />
                <span class="player-name player-name-below">{{ getPlayerName(table, 'east') }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- West Position -->
            <div class="position position-west" 
                 [class.empty]="!hasPlayerAtPosition(table, 'west')"
                 [class.occupied]="hasPlayerAtPosition(table, 'west')"
                 [title]="getPlayerName(table, 'west')"
                 (click)="onPositionClick(table.id, 'west', !!table.positions.west); $event.stopPropagation()">
              @if (hasPlayerAtPosition(table, 'west')) {
                <img [src]="isComputerPlayer(table, 'west') ? '/images/computer.png' : '/api/images/user.png'" alt="West player" />
                <span class="player-name player-name-below">{{ getPlayerName(table, 'west') }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- Table Image -->
            <img src="/api/images/desk.png" [alt]="'Table ' + table.tableNumber" class="table-img" />

            <!-- Watcher Badge -->
            @if (table.watcherCount > 0) {
              <div class="watcher-badge" (click)="onWatchTable(table.id); $event.stopPropagation()">
                <img src="/api/images/user.png" alt="Watchers" class="watcher-icon" />
                <span class="watcher-count">{{ table.watcherCount }}</span>
                @if (table.watchers && table.watchers.length > 0) {
                  <div class="watcher-tooltip">
                    @for (watcher of table.watchers; track watcher.id) {
                      <div class="watcher-name">{{ watcher.username }}</div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="watcher-badge clickable" (click)="onWatchTable(table.id); $event.stopPropagation()" title="Watch this table">
                <img src="/api/images/user.png" alt="Watch" class="watcher-icon" />
                <span class="watcher-count">+</span>
              </div>
            }
          </div>
          <div class="card-content">
            <h3>Table {{ table.tableNumber }}</h3>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Attributions Dialog -->
  @if (showAttributionsDialog) {
    <div class="dialog-overlay" (click)="closeAttributions()">
      <div class="dialog-content attributions-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Attributions</h2>
          <button class="close-btn" (click)="closeAttributions()" aria-label="Close">×</button>
        </div>
        <div class="attributions-content">
          <p><a href="https://www.flaticon.com/free-icons/bureau" title="bureau icons" target="_blank" rel="noopener noreferrer">Bureau icons created by Freepik - Flaticon</a></p>
          <p><a href="https://www.flaticon.com/free-icons/user" title="user icons" target="_blank" rel="noopener noreferrer">User icons created by Freepik - Flaticon</a></p>
          <p><a href="https://www.flaticon.com/free-icons/empty" title="empty icons" target="_blank" rel="noopener noreferrer">Empty icons created by meaicon - Flaticon</a></p>
          <p><a href="https://www.flaticon.com/free-icons/bird" title="bird icons" target="_blank" rel="noopener noreferrer">Bird icons created by Freepik - Flaticon</a></p>
          <p><a href="https://www.flaticon.com/free-icons/computer" title="computer icons" target="_blank" rel="noopener noreferrer">Computer icons created by xnimrodx - Flaticon</a></p>
        </div>
        <div class="dialog-actions">
          <button class="btn btn-primary" (click)="closeAttributions()">Close</button>
        </div>
      </div>
    </div>
  }

  <!-- Preferences Dialog -->
  @if (showPreferencesDialog) {
    <div class="dialog-overlay">
      <div class="dialog-content preferences-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Site Preferences</h2>
          <button class="close-btn" (click)="cancelPreferences()" aria-label="Close">×</button>
        </div>
        @if (errorMessage()) {
          <div class="error-message">
            {{ errorMessage() }}
          </div>
        }
        <div class="preference-item">
          <label for="tableCount">Total Number of Tables (3-36):</label>
          <input 
            type="number" 
            id="tableCount" 
            [(ngModel)]="tableCount"
            min="3" 
            max="36" 
            class="table-count-input"
          />
        </div>
        <div class="preference-item">
          <label for="dealAnimationTime">Deal Animation Time in milliseconds (1000-42000):</label>
          <input 
            type="number" 
            id="dealAnimationTime" 
            [(ngModel)]="dealAnimationTime"
            min="1000" 
            max="42000"
            step="1000" 
            class="table-count-input"
          />
        </div>
        <div class="preference-item">
          <label for="trickAnimationTime">Trick Animation Time in milliseconds (500-5000):</label>
          <input 
            type="number" 
            id="trickAnimationTime" 
            [(ngModel)]="trickAnimationTime"
            min="500" 
            max="5000"
            step="100" 
            class="table-count-input"
          />
        </div>
        <div class="preference-item">
          <label for="trickDisplayDelay">Trick Display Delay in milliseconds (500-10000):</label>
          <input 
            type="number" 
            id="trickDisplayDelay" 
            [(ngModel)]="trickDisplayDelay"
            min="500" 
            max="10000"
            step="100" 
            class="table-count-input"
          />
        </div>
        <div class="preference-item">
          <label for="bidWinnerMessageTime">Bid Winner Message Time in milliseconds (10-10000):</label>
          <input 
            type="number" 
            id="bidWinnerMessageTime" 
            [(ngModel)]="bidWinnerMessageTime"
            min="10" 
            max="10000"
            step="100" 
            class="table-count-input"
          />
        </div>
        <p class="warning">Note: Changing table count will remove tables with active games or players if reducing the count.</p>
        <div class="dialog-actions">
          <button class="btn btn-secondary" (click)="cancelPreferences()">Cancel</button>
          <button class="btn btn-primary" (click)="savePreferences()">Save</button>
        </div>
      </div>
    </div>
  }

  <!-- Users Management Dialog -->
  @if (showUsersDialog) {
    <div class="dialog-overlay" (click)="closeUsersDialog()">
      <div class="dialog-content users-dialog" (click)="$event.stopPropagation()">
        <h2>Manage Users</h2>
        
        <div class="users-search">
          <input 
            type="text" 
            placeholder="Search by username, email, first name, or last name..."
            [(ngModel)]="userSearchText"
            (input)="filterUsers()"
            class="search-input"
          />
        </div>

        <div class="users-list">
          @if (filteredUsers.length === 0) {
            <p class="no-users">No users found</p>
          }
          @for (user of filteredUsers; track user.id) {
            <div class="user-row">
              <div class="user-info-column">
                <div class="user-name">{{ user.username }}</div>
                <div class="user-email">{{ user.email }}</div>
                @if (user.firstName || user.lastName) {
                  <div class="user-full-name">{{ user.firstName }} {{ user.lastName }}</div>
                }
                <div class="user-meta">
                  <span class="user-status">Status: {{ user.status }}</span>
                  <span class="user-created">Joined: {{ formatDate(user.createdAt) }}</span>
                </div>
              </div>
              <div class="user-type-column">
                <select 
                  [value]="user.userType"
                  (change)="updateUserType(user, $any($event.target).value)"
                  [class]="getUserTypeClass(user.userType)"
                  class="user-type-select">
                  <option value="admin">Admin</option>
                  <option value="normal">Normal</option>
                  <option value="pending">Pending</option>
                  <option value="banned">Banned</option>
                </select>
              </div>
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button class="btn btn-secondary" (click)="closeUsersDialog()">Close</button>
        </div>
      </div>
    </div>
  }
</div>
