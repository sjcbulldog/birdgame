<div class="home-container">
  @if (errorMessage()) {
    <div class="error-popup">
      <div class="error-content">
        <p>{{ errorMessage() }}</p>
        <button (click)="errorMessage.set(null)">Close</button>
      </div>
    </div>
  }

  <nav class="navbar">
    <div class="nav-content">
      <h1>Birds Application</h1>
      <div class="nav-actions">
        @if (currentUser) {
          <span class="user-info">
            Welcome, {{ currentUser.username }}!
          </span>
        }
        <div style="position: relative;">
          <button class="btn btn-menu" (click)="toggleMenu()">☰</button>
          @if (showMenu) {
            <div class="dropdown-menu">
              @if (currentUser?.userType === 'admin') {
                <button class="menu-item" (click)="openPreferences()">Preferences</button>
              }
              <button class="menu-item" (click)="logout()">Logout</button>
            </div>
          }
        </div>
      </div>
    </div>
  </nav>

  <div class="content">
    <div class="cards-grid">
      @for (table of tables(); track table.id) {
        <div class="card">
          <div class="card-image" (click)="onCardImageClick($event, table.id)">
            <!-- Start Button -->
            @if (hasPlayers(table) && isUserAtTable(table)) {
              <button class="start-button" (click)="startGame(table.id); $event.stopPropagation()" title="Start game">
                Start
              </button>
            }
            
            <!-- North Position -->
            <div class="position position-north" 
                 [class.empty]="!table.positions.north"
                 [class.occupied]="!!table.positions.north"
                 [title]="table.positions.north?.username || ''"
                 (click)="onPositionClick(table.id, 'north', !!table.positions.north); $event.stopPropagation()">
              @if (table.positions.north) {
                <img src="/api/images/user.png" alt="North player" />
                <span class="player-name player-name-left">{{ table.positions.north.username }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- South Position -->
            <div class="position position-south" 
                 [class.empty]="!table.positions.south"
                 [class.occupied]="!!table.positions.south"
                 [title]="table.positions.south?.username || ''"
                 (click)="onPositionClick(table.id, 'south', !!table.positions.south); $event.stopPropagation()">
              @if (table.positions.south) {
                <img src="/api/images/user.png" alt="South player" />
                <span class="player-name player-name-right">{{ table.positions.south.username }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- East Position -->
            <div class="position position-east" 
                 [class.empty]="!table.positions.east"
                 [class.occupied]="!!table.positions.east"
                 [title]="table.positions.east?.username || ''"
                 (click)="onPositionClick(table.id, 'east', !!table.positions.east); $event.stopPropagation()">
              @if (table.positions.east) {
                <img src="/api/images/user.png" alt="East player" />
                <span class="player-name player-name-below">{{ table.positions.east.username }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- West Position -->
            <div class="position position-west" 
                 [class.empty]="!table.positions.west"
                 [class.occupied]="!!table.positions.west"
                 [title]="table.positions.west?.username || ''"
                 (click)="onPositionClick(table.id, 'west', !!table.positions.west); $event.stopPropagation()">
              @if (table.positions.west) {
                <img src="/api/images/user.png" alt="West player" />
                <span class="player-name player-name-below">{{ table.positions.west.username }}</span>
              } @else {
                <img src="/api/images/frame.png" alt="Empty seat" />
              }
            </div>

            <!-- Table Image -->
            <img src="/api/images/desk.png" [alt]="'Table ' + table.tableNumber" class="table-img" />

            <!-- Watcher Badge -->
            @if (table.watcherCount > 0) {
              <div class="watcher-badge" (click)="onWatchTable(table.id); $event.stopPropagation()">
                <img src="/api/images/user.png" alt="Watchers" class="watcher-icon" />
                <span class="watcher-count">{{ table.watcherCount }}</span>
              </div>
            } @else {
              <div class="watcher-badge clickable" (click)="onWatchTable(table.id); $event.stopPropagation()" title="Watch this table">
                <img src="/api/images/user.png" alt="Watch" class="watcher-icon" />
                <span class="watcher-count">+</span>
              </div>
            }
          </div>
          <div class="card-content">
            <h3>Table {{ table.tableNumber }}</h3>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Preferences Dialog -->
  @if (showPreferencesDialog) {
    <div class="dialog-overlay">
      <div class="dialog-content preferences-dialog" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Site Preferences</h2>
          <button class="close-btn" (click)="cancelPreferences()" aria-label="Close">×</button>
        </div>
        <div class="preference-item">
          <label for="tableCount">Total Number of Tables (3-36):</label>
          <input 
            type="number" 
            id="tableCount" 
            [(ngModel)]="tableCount"
            min="3" 
            max="36" 
            class="table-count-input"
          />
        </div>
        <div class="preference-item">
          <label for="dealAnimationTime">Deal Animation Time in milliseconds (1000-42000):</label>
          <input 
            type="number" 
            id="dealAnimationTime" 
            [(ngModel)]="dealAnimationTime"
            min="1000" 
            max="42000"
            step="1000" 
            class="table-count-input"
          />
        </div>
        <p class="warning">Note: Changing table count will remove tables with active games or players if reducing the count.</p>
        <div class="dialog-actions">
          <button class="btn btn-secondary" (click)="cancelPreferences()">Cancel</button>
          <button class="btn btn-primary" (click)="savePreferences()">Save</button>
        </div>
      </div>
    </div>
  }
</div>
